<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layout}">
<head>
    <title th:text="${pageTitle}">比赛关键事件表单</title>
</head>
<body>
<div layout:fragment="content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 th:text="${pageTitle}">比赛关键事件表单</h1>
        <a th:href="@{/}" class="btn btn-outline-secondary">
            <i class="fas fa-home"></i> 返回首页
        </a>
    </div>

    <!-- 错误信息显示 -->
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong>错误!</strong> <span th:text="${error}">发生错误</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-edit"></i> 关键事件信息
            </h5>
        </div>
        <div class="card-body">
            <form th:action="@{/matches/events/save}" method="post" id="eventForm">
                <!-- 隐藏字段 -->
                <input type="hidden" name="eventId" th:value="${matchEvent.eventId}" />

                <div class="row">
                    <div class="col-md-6">
                        <!-- 事件类型选择 -->
                        <div class="mb-3">
                            <label for="eventType" class="form-label">
                                <span class="text-danger">*</span> 关键事件类型
                            </label>
                            <select name="eventType" class="form-select" id="eventType" required>
                                <option value="">请选择关键事件类型</option>
                                <option th:each="type : ${T(com.niit.esports.entity.MatchEvent).getEventTypes()}"
                                        th:value="${type}"
                                        th:selected="${matchEvent.eventType == type}"
                                        th:text="${T(com.niit.esports.entity.MatchEvent).getEventTypeDisplayName(type)}">
                                </option>
                            </select>
                            <div class="form-text">选择对应的关键事件类型</div>
                        </div>

                        <!-- 比赛ID输入 -->
                        <div class="mb-3">
                            <label for="matchId" class="form-label">
                                <span class="text-danger">*</span> 比赛ID
                            </label>
                            <input type="text" name="matchId" class="form-control" id="matchId"
                                   th:value="${matchEvent.matchId}" required>
                            <div class="form-text">请输入比赛ID</div>
                        </div>

                        <!-- 选手ID输入 -->
                        <div class="mb-3">
                            <label for="playerId" class="form-label">
                                <span class="text-danger">*</span> 选手ID
                            </label>
                            <input type="text" name="playerId" class="form-control" id="playerId"
                                   th:value="${matchEvent.playerId}" required>
                            <div class="form-text">触发关键事件的选手ID</div>
                        </div>

                        <!-- 英雄ID输入 -->
                        <div class="mb-3">
                            <label for="heroId" class="form-label">
                                <span class="text-danger">*</span> 英雄ID
                            </label>
                            <input type="text" name="heroId" class="form-control" id="heroId"
                                   th:value="${matchEvent.heroId}" required>
                            <div class="form-text">选手使用的英雄ID</div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <!-- 时间戳输入 -->
                        <div class="mb-3">
                            <label for="timestampSeconds" class="form-label">
                                <span class="text-danger">*</span> 比赛时间（秒）
                            </label>
                            <input type="number" name="timestampSeconds" class="form-control"
                                   id="timestampSeconds" min="0" max="3600" required
                                   th:value="${matchEvent.timestampSeconds}"
                                   placeholder="例如: 600 表示 10:00">
                            <div class="form-text">
                                当前时间: <span id="timeDisplay" class="fw-bold">00:00</span>
                                （格式: 分钟:秒）
                            </div>
                        </div>

                        <!-- 金币输入 -->
                        <div class="mb-3">
                            <label for="gold" class="form-label">获得金币</label>
                            <input type="number" name="gold" class="form-control"
                                   id="gold" min="0" step="50"
                                   th:value="${matchEvent.gold}"
                                   placeholder="可选，默认为0">
                            <div class="form-text">事件获得的金币数量</div>
                        </div>

                        <!-- 目标选手ID输入 -->
                        <div class="mb-3">
                            <label for="targetPlayerId" class="form-label">目标选手ID</label>
                            <input type="text" name="targetPlayerId" class="form-control" id="targetPlayerId"
                                   th:value="${matchEvent.targetPlayerId}">
                            <div class="form-text">仅对击杀、助攻等需要目标的事件填写</div>
                        </div>

                        <!-- 表单状态指示器 -->
                        <div class="card mt-3">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-info-circle"></i> 表单状态
                                </h6>
                                <div class="small">
                                    <div class="d-flex justify-content-between">
                                        <span>事件ID:</span>
                                        <span th:if="${matchEvent.eventId != null}"
                                              class="badge bg-success" th:text="${matchEvent.eventId}">ID</span>
                                        <span th:if="${matchEvent.eventId == null}"
                                              class="badge bg-info">新关键事件</span>
                                    </div>
                                    <div class="d-flex justify-content-between mt-1">
                                        <span>关键事件类型:</span>
                                        <span th:if="${matchEvent.eventType != null}"
                                              class="badge bg-primary" th:text="${matchEvent.eventType}">类型</span>
                                        <span th:if="${matchEvent.eventType == null}"
                                              class="badge bg-secondary">未选择</span>
                                    </div>
                                    <div class="d-flex justify-content-between mt-1">
                                        <span>比赛ID:</span>
                                        <span th:if="${matchEvent.matchId != null}"
                                              class="badge bg-warning text-dark" th:text="${matchEvent.matchId}">比赛</span>
                                        <span th:if="${matchEvent.matchId == null}"
                                              class="badge bg-secondary">未填写</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 表单操作按钮 -->
                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4 border-top pt-4">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-save"></i>
                        <span th:text="${matchEvent.eventId != null ? '更新事件' : '创建事件'}">保存事件</span>
                    </button>
                    <a th:href="@{/matches/events}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-times"></i> 取消
                    </a>
                    <button type="reset" class="btn btn-outline-warning">
                        <i class="fas fa-undo"></i> 重置表单
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 事件类型说明 -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-lightbulb"></i> 关键事件类型说明
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6>基础事件:</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="fas fa-tint text-danger me-2"></i>
                            <strong>一血 (FIRST_BLOOD)</strong> - 比赛中的第一个击杀
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-skull-crossbones text-dark me-2"></i>
                            <strong>团灭 (ACE)</strong> - 消灭对方全部队员
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-fort-awesome text-warning me-2"></i>
                            <strong>一塔 (FIRST_TOWER)</strong> - 摧毁的第一座防御塔
                        </li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6>资源事件:</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="fas fa-dragon text-success me-2"></i>
                            <strong>巨龙事件</strong> - 海洋/炼狱/山脉/云端/远古巨龙
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-crown text-purple me-2"></i>
                            <strong>男爵 (BARON)</strong> - 击败纳什男爵
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-eye text-warning me-2"></i>
                            <strong>峡谷先锋 (HERALD)</strong> - 击败峡谷先锋
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div layout:fragment="scripts">
    <script>
        $(document).ready(function() {
            console.log('事件表单页面加载完成');

            // 实时显示时间格式
            function updateTimeDisplay() {
                const seconds = parseInt($('#timestampSeconds').val()) || 0;
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                $('#timeDisplay').text(
                    `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`
                );
            }

            // 初始化时间显示
            updateTimeDisplay();

            // 时间输入框变化时更新显示
            $('#timestampSeconds').on('input', updateTimeDisplay);

            // 表单提交前的验证
            $('#eventForm').on('submit', function(e) {
                const eventType = $('#eventType').val();
                const matchId = $('#matchId').val();
                const playerId = $('#playerId').val();
                const heroId = $('#heroId').val();
                const timestamp = $('#timestampSeconds').val();

                // 基本验证
                if (!eventType) {
                    alert('请选择事件类型！');
                    $('#eventType').focus();
                    e.preventDefault();
                    return false;
                }
                if (!matchId) {
                    alert('请输入比赛ID！');
                    $('#matchId').focus();
                    e.preventDefault();
                    return false;
                }
                if (!playerId) {
                    alert('请输入选手ID！');
                    $('#playerId').focus();
                    e.preventDefault();
                    return false;
                }
                if (!heroId) {
                    alert('请输入英雄ID！');
                    $('#heroId').focus();
                    e.preventDefault();
                    return false;
                }
                if (!timestamp) {
                    alert('请输入比赛时间！');
                    $('#timestampSeconds').focus();
                    e.preventDefault();
                    return false;
                }

                // 时间范围验证
                const timestampNum = parseInt(timestamp);
                if (timestampNum < 0 || timestampNum > 3600) {
                    alert('比赛时间必须在 0-3600 秒范围内！');
                    $('#timestampSeconds').focus();
                    e.preventDefault();
                    return false;
                }

                // 特定事件类型的验证
                const needsTarget = ['FIRST_BLOOD']; // 需要目标选手的事件类型
                const targetPlayerId = $('#targetPlayerId').val();

                if (needsTarget.includes(eventType) && !targetPlayerId) {
                    if (!confirm('当前事件类型建议填写目标选手ID，确定要继续提交吗？')) {
                        e.preventDefault();
                        return false;
                    }
                }

                // 显示提交确认
                const isEdit = $('#eventId').val() !== '';
                const action = isEdit ? '更新' : '创建';

                if (!confirm(`确定要${action}这个事件吗？`)) {
                    e.preventDefault();
                    return false;
                }

                return true;
            });

            // 表单重置确认
            $('button[type="reset"]').on('click', function(e) {
                if (!confirm('确定要重置表单吗？所有输入的内容都将被清除。')) {
                    e.preventDefault();
                    return false;
                }
            });

            // 实时表单验证提示
            $('input[required], select[required]').on('blur', function() {
                const $this = $(this);
                if (!$this.val()) {
                    $this.addClass('is-invalid');
                } else {
                    $this.removeClass('is-invalid');
                }
            });

            // 显示表单数据变化（调试用）
            $('input, select').on('change', function() {
                console.log('表单数据变化:', {
                    eventId: $('#eventId').val(),
                    eventType: $('#eventType').val(),
                    matchId: $('#matchId').val(),
                    playerId: $('#playerId').val(),
                    heroId: $('#heroId').val(),
                    timestampSeconds: $('#timestampSeconds').val(),
                    gold: $('#gold').val(),
                    targetPlayerId: $('#targetPlayerId').val()
                });
            });
        });
    </script>

    <style>
        .form-select:required:invalid {
            color: #6c757d;
        }
        .form-select option {
            color: #000;
        }
        .form-label .text-danger {
            font-size: 1.2em;
        }
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid rgba(0, 0, 0, 0.125);
        }
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid rgba(0, 0, 0, 0.125);
        }
        #timeDisplay {
            color: #0d6efd;
            font-family: 'Courier New', monospace;
        }
        .is-invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }
    </style>
</div>
</body>
</html>