<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.niit.esports.mapper.MatchPickBanMapper">
    
    <resultMap id="MatchPickBanMap" type="MatchPickBan">
        <id property="pickBanId" column="pick_ban_id"/>
        <result property="heroId" column="hero_id"/>
        <result property="action" column="action"/>
        <result property="turn" column="turn"/>
        <result property="matchId" column="match_id"/>
        <result property="teamId" column="team_id"/>
        
        <!-- 关联英雄信息 -->
        <association property="hero" javaType="Hero">
            <id property="heroId" column="hero_id"/>
            <result property="heroName" column="hero_name"/>
            <result property="role" column="role"/>
            <result property="avatarUrl" column="avater_url"/>
        </association>
        
        <!-- 关联队伍信息 -->
        <association property="team" javaType="Team">
            <id property="teamId" column="team_id"/>
            <result property="teamName" column="team_name"/>
            <result property="region" column="region"/>
            <result property="logoUrl" column="logo_url"/>
        </association>
        
        <!-- 关联比赛信息 -->
        <association property="match" javaType="Match">
            <id property="matchId" column="match_id"/>
            <result property="matchTime" column="match_time"/>
            <result property="durationSeconds" column="duration_seconds"/>
            <result property="score" column="score"/>
            <result property="teamAId" column="team_a_id"/>
            <result property="teamBId" column="team_b_id"/>
            <!-- 关联队伍信息 -->
            <association property="teamA" javaType="Team">
                <id property="teamId" column="team_a_id"/>
                <result property="teamName" column="team_a_name"/>
            </association>
            <association property="teamB" javaType="Team">
                <id property="teamId" column="team_b_id"/>
                <result property="teamName" column="team_b_name"/>
            </association>
        </association>
    </resultMap>
    
    <!-- 查询所有记录 -->
    <select id="findAll" resultMap="MatchPickBanMap">
        SELECT mpb.*,
               h.hero_name, h.role, h.avater_url,
               t.team_name, t.region, t.logo_url,
               m.match_time, m.duration_seconds, m.score,
               m.team_a_id, m.team_b_id,
               ta.team_name as team_a_name,
               tb.team_name as team_b_name
        FROM match_pick_ban mpb
                 LEFT JOIN hero h ON mpb.hero_id = h.hero_id
                 LEFT JOIN team t ON mpb.team_id = t.team_id
                 LEFT JOIN matchs m ON mpb.match_id = m.match_id
                 LEFT JOIN team ta ON m.team_a_id = ta.team_id
                 LEFT JOIN team tb ON m.team_b_id = tb.team_id
        ORDER BY mpb.match_id, mpb.turn ASC
    </select>
    
    <!-- 根据ID查询 -->
    <select id="findById" parameterType="String" resultMap="MatchPickBanMap">
        SELECT mpb.*,
               h.hero_name, h.role, h.avater_url,
               t.team_name, t.region, t.logo_url,
               m.match_time, m.duration_seconds, m.score,
               m.team_a_id, m.team_b_id,
               ta.team_name as team_a_name,
               tb.team_name as team_b_name
        FROM match_pick_ban mpb
                 LEFT JOIN hero h ON mpb.hero_id = h.hero_id
                 LEFT JOIN team t ON mpb.team_id = t.team_id
                 LEFT JOIN matchs m ON mpb.match_id = m.match_id
                 LEFT JOIN team ta ON m.team_a_id = ta.team_id
                 LEFT JOIN team tb ON m.team_b_id = tb.team_id
        WHERE mpb.pick_ban_id = #{pickBanId}
    </select>
    
    <!-- 根据比赛ID查询 -->
    <select id="findByMatchId" parameterType="String" resultMap="MatchPickBanMap">
        SELECT mpb.*,
               h.hero_name, h.role, h.avater_url,
               t.team_name, t.region, t.logo_url,
               m.match_time, m.duration_seconds, m.score,
               m.team_a_id, m.team_b_id,
               ta.team_name as team_a_name,
               tb.team_name as team_b_name
        FROM match_pick_ban mpb
                 LEFT JOIN hero h ON mpb.hero_id = h.hero_id
                 LEFT JOIN team t ON mpb.team_id = t.team_id
                 LEFT JOIN matchs m ON mpb.match_id = m.match_id
                 LEFT JOIN team ta ON m.team_a_id = ta.team_id
                 LEFT JOIN team tb ON m.team_b_id = tb.team_id
        WHERE mpb.match_id = #{matchId}
        ORDER BY mpb.turn ASC
    </select>
    
    <!-- 根据队伍ID查询 -->
    <select id="findByTeamId" parameterType="String" resultMap="MatchPickBanMap">
        SELECT mpb.*,
               h.hero_name, h.role, h.avater_url,
               t.team_name, t.region, t.logo_url,
               m.match_time, m.duration_seconds, m.score,
               m.team_a_id, m.team_b_id,
               ta.team_name as team_a_name,
               tb.team_name as team_b_name
        FROM match_pick_ban mpb
                 LEFT JOIN hero h ON mpb.hero_id = h.hero_id
                 LEFT JOIN team t ON mpb.team_id = t.team_id
                 LEFT JOIN matchs m ON mpb.match_id = m.match_id
                 LEFT JOIN team ta ON m.team_a_id = ta.team_id
                 LEFT JOIN team tb ON m.team_b_id = tb.team_id
        WHERE mpb.team_id = #{teamId}
        ORDER BY mpb.match_id, mpb.turn ASC
    </select>
    
    <!-- 根据比赛ID和队伍ID查询 -->
    <select id="findByMatchIdAndTeamId" resultMap="MatchPickBanMap">
        SELECT mpb.*,
               h.hero_name, h.role, h.avater_url,
               t.team_name, t.region, t.logo_url,
               m.match_time, m.duration_seconds, m.score,
               m.team_a_id, m.team_b_id,
               ta.team_name as team_a_name,
               tb.team_name as team_b_name
        FROM match_pick_ban mpb
                 LEFT JOIN hero h ON mpb.hero_id = h.hero_id
                 LEFT JOIN team t ON mpb.team_id = t.team_id
                 LEFT JOIN matchs m ON mpb.match_id = m.match_id
                 LEFT JOIN team ta ON m.team_a_id = ta.team_id
                 LEFT JOIN team tb ON m.team_b_id = tb.team_id
        WHERE mpb.match_id = #{matchId} AND mpb.team_id = #{teamId}
        ORDER BY mpb.turn ASC
    </select>
    
    <!-- 根据比赛ID和操作类型查询 -->
    <select id="findByMatchIdAndAction" resultMap="MatchPickBanMap">
        SELECT mpb.*,
               h.hero_name, h.role, h.avater_url,
               t.team_name, t.region, t.logo_url,
               m.match_time, m.duration_seconds, m.score,
               m.team_a_id, m.team_b_id,
               ta.team_name as team_a_name,
               tb.team_name as team_b_name
        FROM match_pick_ban mpb
                 LEFT JOIN hero h ON mpb.hero_id = h.hero_id
                 LEFT JOIN team t ON mpb.team_id = t.team_id
                 LEFT JOIN matchs m ON mpb.match_id = m.match_id
                 LEFT JOIN team ta ON m.team_a_id = ta.team_id
                 LEFT JOIN team tb ON m.team_b_id = tb.team_id
        WHERE mpb.match_id = #{matchId} AND mpb.action = #{action}
        ORDER BY mpb.turn ASC
    </select>
    
    <!-- 根据比赛ID分页查询 -->
    <select id="findByMatchIdWithPage" resultMap="MatchPickBanMap">
        SELECT mpb.*,
               h.hero_name, h.role, h.avater_url,
               t.team_name, t.region, t.logo_url,
               m.match_time, m.duration_seconds, m.score,
               m.team_a_id, m.team_b_id,
               ta.team_name as team_a_name,
               tb.team_name as team_b_name
        FROM match_pick_ban mpb
                 LEFT JOIN hero h ON mpb.hero_id = h.hero_id
                 LEFT JOIN team t ON mpb.team_id = t.team_id
                 LEFT JOIN matchs m ON mpb.match_id = m.match_id
                 LEFT JOIN team ta ON m.team_a_id = ta.team_id
                 LEFT JOIN team tb ON m.team_b_id = tb.team_id
        WHERE mpb.match_id = #{matchId}
        ORDER BY mpb.turn ASC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 插入新记录 -->
    <insert id="insert" parameterType="MatchPickBan">
        INSERT INTO match_pick_ban (pick_ban_id, hero_id, action, turn, match_id, team_id)
        VALUES (#{pickBanId}, #{heroId}, #{action}, #{turn}, #{matchId}, #{teamId})
    </insert>
    
    <!-- 更新记录 -->
    <update id="update" parameterType="MatchPickBan">
        UPDATE match_pick_ban
        SET hero_id = #{heroId},
            action = #{action},
            turn = #{turn},
            match_id = #{matchId},
            team_id = #{teamId}
        WHERE pick_ban_id = #{pickBanId}
    </update>
    
    <!-- 删除记录 -->
    <delete id="delete" parameterType="String">
        DELETE FROM match_pick_ban WHERE pick_ban_id = #{pickBanId}
    </delete>
    
    <!-- 统计比赛记录数 -->
    <select id="countByMatchId" parameterType="String" resultType="int">
        SELECT COUNT(*) FROM match_pick_ban WHERE match_id = #{matchId}
    </select>
    
    <!-- 统计比赛某种操作的记录数 -->
    <select id="countByMatchIdAndAction" resultType="int">
        SELECT COUNT(*) FROM match_pick_ban 
        WHERE match_id = #{matchId} AND action = #{action}
    </select>
</mapper>