<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layout}">
<head>
    <title th:text="${pageTitle}">比赛关键事件列表</title>
</head>
<body>
<div layout:fragment="content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 th:text="${pageTitle}">比赛关键事件列表</h1>
        <a th:href="@{/}" class="btn btn-outline-secondary">
            <i class="fas fa-home"></i> 返回首页
        </a>
    </div>

    <!-- 错误信息显示 -->
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong>错误!</strong> <span th:text="${error}">发生错误</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- 比赛信息 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-gamepad"></i> 比赛信息
            </h5>
        </div>
        <div class="card-body text-center">
            <div class="row">
                <div class="col-12">
                    <p class="mb-1" th:if="${currentMatch != null}">
                        <i class="far fa-clock me-1"></i>
                        <span th:text="${#dates.format(currentMatch.matchTime, 'yyyy-MM-dd HH:mm')}">2025-10-28 15:00</span>
                    </p>
                    <p class="mb-0">
                        <span class="fs-4 text-primary me-4" th:text="${currentMatch.teamA != null ? currentMatch.teamA.teamName : '队伍A'}">GenG</span>
                        <span class="fs-3 fw-bold mx-3" th:text="${currentMatch.score != null ? currentMatch.score : '0:0'}">3:1</span>
                        <span class="fs-4 text-danger ms-4" th:text="${currentMatch.teamB != null ? currentMatch.teamB.teamName : '队伍B'}">HLE</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- 小局切换标签 -->
    <div th:if="${totalRounds > 0}" class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-layer-group me-2"></i>小局选择
            </h5>
        </div>
        <div class="card-body">
            <div class="d-flex flex-wrap gap-2">
                <a th:each="roundNum : ${#numbers.sequence(1, totalRounds)}"
                   th:href="@{/matches/events/match/{matchId}(matchId=${matchId}, round=${roundNum})}"
                   th:class="'btn ' + (${roundNum == currentRound} ? 'btn-primary' : 'btn-outline-primary')">
                    第<span th:text="${roundNum}">1</span>局
                    <span th:if="${allEvents != null}"
                          class="badge bg-light text-dark ms-1"
                          th:text="${#lists.size(allEvents) >= (roundNum * 11) ? 11 : #lists.size(allEvents) % 11}">
                        11
                    </span>
                </a>
            </div>
        </div>
    </div>

    <!-- 当前小局信息 -->
    <div th:if="${totalRounds > 0}" class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="text-primary">
            <i class="fas fa-flag me-2"></i>
            第 <span th:text="${currentRound}">1</span> 局
            <small class="text-muted ms-2">
                (共 <span th:text="${#lists.size(events)}">0</span> 个关键事件)
            </small>
        </h5>
        <a th:href="@{/matches/events/stats/{matchId}(matchId=${matchId})}" class="btn btn-info">
            <i class="fas fa-chart-bar"></i> 关键事件统计
        </a>
    </div>

    <!-- 事件列表 -->
    <div class="card">
        <div class="card-body">
            <div th:if="${!#lists.isEmpty(events)}" class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                    <tr>
                        <th>序号</th>
                        <th>时间</th>
                        <th>关键事件类型</th>
                        <th>选手</th>
                        <th>英雄</th>
                        <th>金币</th>
                        <th>目标选手</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="event,iter : ${events}">
                        <!-- 序号列 -->
                        <td>
                                <span class="badge bg-secondary"
                                      th:text="${(currentRound - 1) * 11 + iter.index + 1}">1</span>
                        </td>

                        <!-- 时间列 -->
                        <td>
                            <span class="fw-bold" th:text="${T(com.niit.esports.util.EventUtils).formatTime(event.timestampSeconds)}">00:00</span>
                            <br>
                            <small class="text-muted" th:text="'(' + ${event.timestampSeconds} + 's)'">(0s)</small>
                        </td>

                        <!-- 事件类型列 -->
                        <td>
                            <div class="d-flex align-items-center">
                                <i th:class="'fas ' + ${T(com.niit.esports.util.EventUtils).getEventIconClass(event.eventType)} + ' me-2'"
                                   th:classappend="' text-' + ${#strings.toLowerCase(event.eventType) == 'first_blood' ? 'danger' :
                                                           #strings.toLowerCase(event.eventType).contains('dragon') ? 'success' :
                                                           #strings.toLowerCase(event.eventType) == 'baron' ? 'purple' :
                                                           #strings.toLowerCase(event.eventType) == 'herald' ? 'warning' :
                                                           #strings.toLowerCase(event.eventType) == 'first_tower' ? 'info' :
                                                           #strings.toLowerCase(event.eventType) == 'ace' ? 'dark' : 'secondary'}"></i>
                                <span th:text="${T(com.niit.esports.entity.MatchEvent).getEventTypeDisplayName(event.eventType)}">事件类型</span>
                            </div>
                        </td>

                        <!-- 选手列 -->
                        <td th:text="${event.player != null ? event.player.gameName : 'N/A'}">选手</td>

                        <!-- 英雄列 -->
                        <td th:text="${event.hero != null ? event.hero.heroName : 'N/A'}">英雄</td>

                        <!-- 金币列 -->
                        <td>
                                <span th:if="${event.gold != null && event.gold != ''}"
                                      class="badge bg-warning text-dark" th:text="${event.gold}">金币</span>
                            <span th:if="${event.gold == null || event.gold == ''}" class="text-muted">-</span>
                        </td>

                        <!-- 目标选手列 -->
                        <td th:text="${event.targetPlayer != null ? event.targetPlayer.gameName : '-'}">目标</td>

                        <!-- 操作列 -->
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <a th:href="@{/matches/events/edit/{eventId}(eventId=${event.eventId})}"
                                   class="btn btn-outline-primary">
                                    <i class="fas fa-edit"></i> 编辑
                                </a>
                                <form th:action="@{/matches/events/delete/{eventId}(eventId=${event.eventId})}"
                                      method="post" class="d-inline">
                                    <input type="hidden" name="matchId" th:value="${matchId}">
                                    <button type="submit" class="btn btn-outline-danger"
                                            onclick="return confirm('确定删除这个事件吗？此操作不可撤销。')">
                                        <i class="fas fa-trash"></i> 删除
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- 无事件提示 -->
            <div th:if="${#lists.isEmpty(events)}" class="text-center py-5">
                <i class="fas fa-inbox fa-3x mb-3 text-muted"></i>
                <h5 class="text-muted" th:if="${totalRounds > 0}">
                    第 <span th:text="${currentRound}">1</span> 局暂无事件数据
                </h5>
                <h5 class="text-muted" th:if="${totalRounds == 0}">暂无事件数据</h5>
                <p class="text-muted">该小局目前还没有添加任何事件。</p>
            </div>
        </div>
    </div>

    <!-- 小局导航 -->
    <div th:if="${totalRounds > 1}" class="card mt-4">
        <div class="card-body">
            <div class="d-flex justify-content-between">
                <a th:if="${currentRound > 1}"
                   th:href="@{/matches/events/match/{matchId}(matchId=${matchId}, round=${currentRound - 1})}"
                   class="btn btn-outline-primary">
                    <i class="fas fa-chevron-left"></i> 上一局
                </a>
                <span th:unless="${currentRound > 1}" class="btn btn-outline-secondary disabled">
                    <i class="fas fa-chevron-left"></i> 上一局
                </span>

                <span class="text-muted">
                    第 <span th:text="${currentRound}">1</span> 局 / 共 <span th:text="${totalRounds}">1</span> 局
                </span>

                <a th:if="${currentRound < totalRounds}"
                   th:href="@{/matches/events/match/{matchId}(matchId=${matchId}, round=${currentRound + 1})}"
                   class="btn btn-outline-primary">
                    下一局 <i class="fas fa-chevron-right"></i>
                </a>
                <span th:unless="${currentRound < totalRounds}" class="btn btn-outline-secondary disabled">
                    下一局 <i class="fas fa-chevron-right"></i>
                </span>
            </div>
        </div>
    </div>
</div>

<div layout:fragment="scripts">
    <script>
        $(document).ready(function() {
            console.log('比赛事件列表页面加载完成');

            // 确认删除对话框
            $('.btn-outline-danger').on('click', function(e) {
                if (!confirm('确定要删除这个关键事件吗？此操作不可撤销。')) {
                    e.preventDefault();
                }
            });
        });
    </script>

    <style>
        .table th {
            border-top: none;
            font-weight: 600;
        }

        .table > tbody > tr:hover {
            background-color: rgba(0, 123, 255, 0.05);
        }

        .btn-group-sm > .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        .text-purple {
            color: #6f42c1 !important;
        }

        /* 小局选择按钮样式 */
        .btn-outline-primary.active {
            background-color: #0d6efd;
            border-color: #0d6efd;
            color: white;
        }
    </style>
</div>
</body>
</html>