<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.niit.esports.mapper.MatchEventMapper">

    <resultMap id="MatchEventMap" type="MatchEvent">
        <id property="eventId" column="event_id"/>
        <result property="eventType" column="event_type"/>
        <result property="timestampSeconds" column="timestamp_seconds"/>
        <result property="gold" column="gold"/>
        <result property="heroId" column="hero_id"/>
        <result property="matchId" column="match_id"/>
        <result property="playerId" column="player_id"/>
        <result property="targetPlayerId" column="target_player_id"/>

        <!-- 关联英雄信息 -->
        <association property="hero" javaType="Hero">
            <id property="heroId" column="hero_id"/>
            <result property="heroName" column="hero_name"/>
        </association>

        <!-- 关联选手信息 -->
        <association property="player" javaType="Player">
            <id property="playerId" column="player_id"/>
            <result property="gameName" column="player_game_name"/>
        </association>

        <!-- 关联目标选手信息 -->
        <association property="targetPlayer" javaType="Player">
            <id property="playerId" column="target_player_id"/>
            <result property="gameName" column="target_game_name"/>
        </association>

        <!-- 关联比赛信息 -->
        <association property="match" javaType="Match">
            <id property="matchId" column="match_id"/>
            <result property="matchTime" column="match_time"/>
            <result property="teamAId" column="team_a_id"/>
            <result property="teamBId" column="team_b_id"/>
            <result property="score" column="score"/>
            <association property="teamA" javaType="Team">
                <id property="teamId" column="team_a_id"/>
                <result property="teamName" column="team_a_name"/>
            </association>
            <association property="teamB" javaType="Team">
                <id property="teamId" column="team_b_id"/>
                <result property="teamName" column="team_b_name"/>
            </association>
        </association>
    </resultMap>

    <!-- 根据ID查询事件 -->
    <select id="findById" parameterType="String" resultMap="MatchEventMap">
        SELECT me.*,
               h.hero_name,
               p.game_name as player_game_name,
               tp.game_name as target_game_name,
               m.match_time, m.team_a_id, m.team_b_id, m.score,
               ta.team_name as team_a_name,
               tb.team_name as team_b_name
        FROM match_event me
                 LEFT JOIN hero h ON me.hero_id = h.hero_id
                 LEFT JOIN player p ON me.player_id = p.player_id
                 LEFT JOIN player tp ON me.target_player_id = tp.player_id
                 LEFT JOIN matchs m ON me.match_id = m.match_id
                 LEFT JOIN team ta ON m.team_a_id = ta.team_id
                 LEFT JOIN team tb ON m.team_b_id = tb.team_id
        WHERE me.event_id = #{eventId}
    </select>

    <!-- 根据比赛ID查询事件（按事件ID排序） -->
    <select id="findByMatchId" parameterType="String" resultMap="MatchEventMap">
        SELECT me.*,
               h.hero_name,
               p.game_name as player_game_name,
               tp.game_name as target_game_name,
               m.match_time, m.team_a_id, m.team_b_id, m.score,
               ta.team_name as team_a_name,
               tb.team_name as team_b_name
        FROM match_event me
                 LEFT JOIN hero h ON me.hero_id = h.hero_id
                 LEFT JOIN player p ON me.player_id = p.player_id
                 LEFT JOIN player tp ON me.target_player_id = tp.player_id
                 LEFT JOIN matchs m ON me.match_id = m.match_id
                 LEFT JOIN team ta ON m.team_a_id = ta.team_id
                 LEFT JOIN team tb ON m.team_b_id = tb.team_id
        WHERE me.match_id = #{matchId}
        ORDER BY
            -- 先按事件ID排序（确保分组顺序）
            CAST(REPLACE(me.event_id, 'EVENT_', '') AS UNSIGNED) ASC,
            -- 再按时间排序（确保显示顺序）
            CAST(me.timestamp_seconds AS UNSIGNED) ASC
    </select>

    <!-- 根据选手ID查询事件 -->
    <select id="findByPlayerId" parameterType="String" resultMap="MatchEventMap">
        SELECT me.*,
               h.hero_name,
               p.game_name as player_game_name,
               tp.game_name as target_game_name,
               m.match_time, m.team_a_id, m.team_b_id, m.score,
               ta.team_name as team_a_name,
               tb.team_name as team_b_name
        FROM match_event me
                 LEFT JOIN hero h ON me.hero_id = h.hero_id
                 LEFT JOIN player p ON me.player_id = p.player_id
                 LEFT JOIN player tp ON me.target_player_id = tp.player_id
                 LEFT JOIN matchs m ON me.match_id = m.match_id
                 LEFT JOIN team ta ON m.team_a_id = ta.team_id
                 LEFT JOIN team tb ON m.team_b_id = tb.team_id
        WHERE me.player_id = #{playerId}
        ORDER BY me.timestamp_seconds DESC
    </select>

    <!-- 根据比赛和事件类型查询 -->
    <select id="findByMatchIdAndType" resultMap="MatchEventMap">
        SELECT me.*,
               h.hero_name,
               p.game_name as player_game_name,
               tp.game_name as target_game_name,
               m.match_time, m.team_a_id, m.team_b_id, m.score,
               ta.team_name as team_a_name,
               tb.team_name as team_b_name
        FROM match_event me
                 LEFT JOIN hero h ON me.hero_id = h.hero_id
                 LEFT JOIN player p ON me.player_id = p.player_id
                 LEFT JOIN player tp ON me.target_player_id = tp.player_id
                 LEFT JOIN matchs m ON me.match_id = m.match_id
                 LEFT JOIN team ta ON m.team_a_id = ta.team_id
                 LEFT JOIN team tb ON m.team_b_id = tb.team_id
        WHERE me.match_id = #{matchId} AND me.event_type = #{eventType}
        ORDER BY CAST(me.timestamp_seconds AS UNSIGNED) ASC
    </select>

    <!-- 获取比赛事件统计 -->
    <select id="getEventStatsByMatch" parameterType="String" resultType="map">
        SELECT
            event_type,
            COUNT(*) as event_count,
            SUM(CAST(gold as UNSIGNED)) as total_gold
        FROM match_event
        WHERE match_id = #{matchId}
        GROUP BY event_type
        ORDER BY event_count DESC
    </select>

    <!-- 插入事件 -->
    <insert id="insert" parameterType="MatchEvent">
        INSERT INTO match_event (
            event_id, event_type, timestamp_seconds, gold,
            hero_id, match_id, player_id, target_player_id
        ) VALUES (
                     #{eventId}, #{eventType}, #{timestampSeconds}, #{gold},
                     #{heroId}, #{matchId}, #{playerId}, #{targetPlayerId}
                 )
    </insert>

    <!-- 更新事件 -->
    <update id="update" parameterType="MatchEvent">
        UPDATE match_event
        SET event_type = #{eventType},
            timestamp_seconds = #{timestampSeconds},
            gold = #{gold},
            hero_id = #{heroId},
            match_id = #{matchId},
            player_id = #{playerId},
            target_player_id = #{targetPlayerId}
        WHERE event_id = #{eventId}
    </update>

    <!-- 删除事件 -->
    <delete id="delete" parameterType="String">
        DELETE FROM match_event WHERE event_id = #{eventId}
    </delete>
</mapper>